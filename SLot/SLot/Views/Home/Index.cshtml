@* (Toàn bộ phần HTML, bao gồm các Modal, giữ nguyên như file của bạn) *@
@{
    ViewBag.Title = "Home";
}

@if (TempData["BookingSuccess"] != null)
{
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert" id="bookingSuccessAlert">
        @TempData["BookingSuccess"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div id="map"></div>

<button class="btn btn-primary fab-button" id="btnBookNow">Đặt ngay</button>

<button class="btn location-fab" id="btnFindLocation" title="Tìm vị trí của tôi">
    <i class="bi bi-geo-alt-fill"></i>
</button>

<div id="tripOverlay" class="p-3 bg-white border-top" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;">
    <p>Thời gian di chuyển còn lại: <strong id="tripTimer">15:00</strong></p>
    <button class="btn btn-danger btn-block" id="btnCancelTrip">Hủy chuyến</button>
</div>

<div id="parkingListCarouselContainer" style="display: none;">
    <div id="parkingListCarousel" class="horizontal-scroll-wrapper">
    </div>
</div>


<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Đang tìm bãi đỗ...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận đặt chỗ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmationBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnConfirmBooking">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="refundModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <p>Tài khoản của bạn đã được hoàn lại 50% tiền đặt.</p>
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="predictionModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dự đoán chỗ trống</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Tỉ lệ có chỗ trống (dự đoán) cho <strong id="predictionSlotName"></strong>:</p>
                <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Trong 15 phút
                        <span class="badge badge-primary badge-pill">25%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Trong 30 phút
                        <span class="badge badge-primary badge-pill">40%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Trong 45 phút
                        <span class="badge badge-primary badge-pill">60%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Trong 1 tiếng
                        <span class="badge badge-primary badge-pill">75%</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        Trong 2 tiếng
                        <span class="badge badge-primary badge-pill">90%</span>
                    </li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="futureBookingModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            @using (Html.BeginForm("PlaceBooking", "Home", FormMethod.Post))
            {
                <div class="modal-header">
                    <h5 class="modal-title">Đặt chỗ trước</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Bạn đang đặt chỗ cho: <strong id="futureSlotName"></strong></p>
                    <div class="form-group">
                        <label for="bookingTimeFuture">Vui lòng chọn thời gian:</label>
                        <input type="datetime-local" class="form-control" id="bookingTimeFuture" name="bookingTime" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Xác nhận đặt</button>
                </div>
            }
        </div>
    </div>
</div>


@section scripts {
    <script>
    // (Các biến toàn cục giữ nguyên)
    const currentLocation = [@ViewBag.CurrentLocationLat, @ViewBag.CurrentLocationLng];
    let destinationLocation = [10.784533855868323, 106.69249728774506];

    let map;
    let currentUserData = {};
    let parkingSlotsData = [];
    let selectedSlot = {};
    let tripTimerInterval;
    let routingControl = null;
    let currentMarker;
    let destinationMarker;

    // (initMap và btnFindLocation giữ nguyên)
    function initMap() {
        map = L.map('map').setView(currentLocation, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    }

    $('#btnFindLocation').on('click', function () {
        if (confirm("SLot muốn sử dụng vị trí của bạn. Cho phép?")) {
            if (currentMarker) map.removeLayer(currentMarker);
            if (destinationMarker) map.removeLayer(destinationMarker);
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            currentMarker = L.marker(currentLocation).addTo(map)
                .bindPopup('Vị trí của bạn')
                .openPopup();
            map.panTo(currentLocation);
        } else {
            alert("Không thể lấy vị trí. Vui lòng cấp quyền truy cập vị trí.");
        }
    });

    // (Logic Nút "Đặt ngay" - CẬP NHẬT MÀU NÚT VÀ RESIZE MAP)
    $('#btnBookNow').on('click', function () {
        $('#loadingModal').modal('show');
        const getUser = $.get('@Url.Action("GetCurrentUserData", "Home")');
        const getSlots = $.get('@Url.Action("GetParkingSlots", "Home")');

        Promise.all([getUser, getSlots]).then(function (results) {
            currentUserData = results[0];
            parkingSlotsData = results[1];

            setTimeout(() => {
                $('#loadingModal').modal('hide');
                let listHtml = '';
                parkingSlotsData.forEach(slot => {

                    let buttonHtml = '';
                    if (slot.IsFull) {
                        // --- THAY ĐỔI 1: Đổi màu nút sang Vàng (btn-warning) ---
                        buttonHtml = `
                            <button class="btn btn-sm btn-secondary" disabled>Đã đầy</button>
                            <div class="d-flex justify-content-between mt-2">
                                <button class="btn btn-sm btn-warning btn-predict" data-id="${slot.Id}" data-name="${slot.Name}" style="font-size: 0.75rem;">
                                    <i class="bi bi-graph-up"></i> Xem dự đoán
                                </button>
                                <button class="btn btn-sm btn-warning btn-book-later" data-id="${slot.Id}" data-name="${slot.Name}" style="font-size: 0.75rem;">
                                    <i class="bi bi-clock"></i> Đặt sau
                                </button>
                            </div>
                        `;
                    } else {
                        buttonHtml = `
                            <button class="btn btn-sm btn-primary btn-block select-slot-btn"
                                    data-id="${slot.Id}">Chọn bãi này</button>
                        `;
                    }

                    listHtml += `
                        <div class="card parking-card"
                             data-id="${slot.Id}"
                             data-lat="${slot.Latitude}"
                             data-lng="${slot.Longitude}">
                            <div class="card-body">
                                <img src="@Url.Content("~/")_blank_${slot.ImageUrl.substring(1)}" class="img-fluid rounded mb-2" style="width: 100%; height: 100px; object-fit: cover;">
                                <h6 class="card-title">${slot.Name}</h6>
                                <p class="card-text small">${slot.Address}</p>
                                <p class="card-text"><b>Giá: ${slot.Price.toLocaleString('vi-VN')} VNĐ</b></p>
                                ${buttonHtml}
                            </div>
                        </div>
                    `;
                });
                listHtml = listHtml.replace(/_blank_/g, '');

                $('#parkingListCarousel').html(listHtml);
                $('#parkingListCarouselContainer').show();

                // --- THAY ĐỔI 2: Resize bản đồ khi carousel xuất hiện ---
                map.invalidateSize();

            }, 2000);
        });
    });

    // (Các logic sự kiện click .select-slot-btn, .btn-predict, .btn-book-later, .parking-card giữ nguyên)
    $(document).on('click', '.select-slot-btn', function (e) {
        e.stopPropagation();
        const slotId = $(this).data('id');
        selectedSlot = parkingSlotsData.find(s => s.Id == slotId);

        const remainingBalance = currentUserData.Balance - selectedSlot.Price;

        let confirmHtml = `
            <p><strong>Bãi đỗ xe:</strong> ${selectedSlot.Name}</p>
            <p><strong>Địa chỉ:</strong> ${selectedSlot.Address}</p>
            <hr>
            <p><strong>Tài khoản:</strong> ${currentUserData.UserName}</p>
            <p><strong>Số tiền còn lại:</strong>
                ${currentUserData.Balance.toLocaleString('vi-VN')} - ${selectedSlot.Price.toLocaleString('vi-VN')} =
                <b>${(remainingBalance).toLocaleString('vi-VN')} VNĐ</b>
            </p>
            <p><strong>Thời gian di chuyển (dự kiến):</strong> 15 phút</p>
        `;
        $('#confirmationBody').html(confirmHtml);
        $('#confirmationModal').modal('show');
    });

    $(document).on('click', '.btn-predict', function (e) {
        e.stopPropagation();
        const slotName = $(this).data('name');
        $('#predictionSlotName').text(slotName);
        $('#predictionModal').modal('show');
    });

    $(document).on('click', '.btn-book-later', function (e) {
        e.stopPropagation();
        const slotName = $(this).data('name');
        $('#futureSlotName').text(slotName);
        $('#futureBookingModal').modal('show');
    });

    $(document).on('click', '.parking-card', function () {
        const card = $(this);
        const container = $('#parkingListCarousel');
        const lat = card.data('lat');
        const lng = card.data('lng');
        const name = card.find('.card-title').text();

        const containerWidth = container.width();
        const cardWidth = card.width();
        const cardOffsetLeft = card.position().left;
        const currentScrollLeft = container.scrollLeft();
        const targetScrollLeft = currentScrollLeft + cardOffsetLeft - (containerWidth / 2) + (cardWidth / 2);

        container.animate({ scrollLeft: targetScrollLeft }, 300);

        if (currentMarker) map.removeLayer(currentMarker);
        if (destinationMarker) map.removeLayer(destinationMarker);
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }

        destinationLocation = [lat, lng];
        destinationMarker = L.marker(destinationLocation).addTo(map)
            .bindPopup(name)
            .openPopup();
        map.panTo(destinationLocation);
    });

    // (clearMapExtras giữ nguyên)
    function clearMapExtras() {
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
         if (currentMarker) {
            map.removeLayer(currentMarker);
            currentMarker = null;
        }
        if (routingControl) {
            map.removeControl(routingControl);
            routingControl = null;
        }
        map.closePopup();
    }

    // (Hàm drawRoute - CẬP NHẬT MÀU ĐƯỜNG ĐI)
    function drawRoute() {
        clearMapExtras();

        destinationLocation = [selectedSlot.Latitude, selectedSlot.Longitude];

        map.dragging.disable();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();

        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(currentLocation),
                L.latLng(destinationLocation)
            ],
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            // --- THAY ĐỔI 3: Đổi màu đường đi sang Xanh dương ---
            lineOptions: {
                styles: [{ color: 'blue', opacity: 0.8, weight: 6 }]
            },
            createMarker: function() { return null; }
        }).addTo(map);

        currentMarker = L.marker(currentLocation).addTo(map).bindPopup('Vị trí của bạn');
        destinationMarker = L.marker(destinationLocation).addTo(map).bindPopup(selectedSlot.Name);
    }

    // (startTripTimer - CẬP NHẬT RESIZE MAP)
    function startTripTimer() {
        let duration = 15;
        $('#tripOverlay').show();
        $('#btnBookNow').hide();
        $('#btnFindLocation').hide();
        $('#parkingListCarouselContainer').hide();

        // --- THAY ĐỔI 4: Resize bản đồ khi overlay xuất hiện ---
        map.invalidateSize();

        tripTimerInterval = setInterval(() => {
            duration--;
            let minutes = Math.floor(duration / 60);
            let seconds = duration % 60;
            $('#tripTimer').text(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);

            if (duration <= 0) {
                clearInterval(tripTimerInterval);
                $('#tripOverlay').hide();
                $('#btnBookNow').show();
                $('#btnFindLocation').show();
                clearMapExtras();
                map.dragging.enable();
                map.touchZoom.enable();
                map.doubleClickZoom.enable();
                map.scrollWheelZoom.enable();

                // --- THAY ĐỔI 5: Resize bản đồ khi overlay ẩn đi ---
                map.invalidateSize();

                $('#refundModal').modal('show');
            }
        }, 1000);
    }

    // (btnCancelTrip - CẬP NHẬT RESIZE MAP)
    $('#btnCancelTrip').on('click', function () {
        clearInterval(tripTimerInterval);
        $('#tripOverlay').hide();
        $('#btnBookNow').show();
        $('#btnFindLocation').show();
        clearMapExtras();
        map.dragging.enable();
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
        map.scrollWheelZoom.enable();

        // --- THAY ĐỔI 6: Resize bản đồ khi overlay ẩn đi ---
        map.invalidateSize();

        $('#refundModal').modal('show');
    });

    // (btnConfirmBooking và document.ready giữ nguyên)
    $('#btnConfirmBooking').on('click', function () {
        $('#confirmationModal').modal('hide');
        drawRoute();
        startTripTimer();
    });

    $(document).ready(function () {
        initMap();

        if ($('#bookingSuccessAlert').length) {
            setTimeout(() => {
                $('#bookingSuccessAlert').alert('close');
            }, 5000);
        }
    });

    </script>
}