@{
    ViewBag.Title = "Home";
}

@if (TempData["BookingSuccess"] != null)
{
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert" id="bookingSuccessAlert">
        @TempData["BookingSuccess"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div id="map"></div>

<button class="btn btn-primary fab-button" id="btnBookNow">Đặt ngay</button>

<button class="btn location-fab" id="btnFindLocation" title="Tìm vị trí của tôi">
    <i class="bi bi-geo-alt-fill"></i>
</button>

<div id="tripOverlay" class="p-3 bg-white border-top" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;">
    <p>Thời gian di chuyển còn lại: <strong id="tripTimer">15:00</strong></p>
    <button class="btn btn-danger btn-block" id="btnCancelTrip">Hủy chuyến</button>
</div>

<div id="parkingListCarouselContainer" style="display: none;">
    <div id="parkingListCarousel" class="horizontal-scroll-wrapper">
    </div>
</div>


<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Đang tìm bãi đỗ...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận đặt chỗ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmationBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnConfirmBooking">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="refundModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <p>Tài khoản của bạn đã được hoàn lại 50% tiền đặt.</p>
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script>
    // Vị trí hiện tại (gán cứng)
    const currentLocation = [@ViewBag.CurrentLocationLat, @ViewBag.CurrentLocationLng];
    // Vị trí bãi đỗ xe được chọn (sẽ được cập nhật)
    let destinationLocation = [10.7769, 106.7009];

    let map;
    let currentUserData = {};
    let parkingSlotsData = [];
    let selectedSlot = {};
    let tripTimerInterval;
    let routePolyline;
    let currentMarker; // Marker vị trí hiện tại
    let destinationMarker; // Marker bãi đỗ xe

    // Khởi tạo bản đồ
    function initMap() {
        map = L.map('map').setView(currentLocation, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // KHÔNG thêm marker vị trí hiện tại khi tải trang
    }

    // --- MỚI: Logic nút "Tìm vị trí" ---
    $('#btnFindLocation').on('click', function () {
        // Giả lập kiểm tra quyền GPS [cite: 47]
        // Sử dụng confirm() để người dùng demo có thể chọn "OK" (cho phép) hoặc "Cancel" (từ chối)
        if (confirm("SLot muốn sử dụng vị trí của bạn. Cho phép?")) {
            // Người dùng cho phép (giả lập)
            // Xóa marker cũ (nếu có)
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            // Xóa marker bãi đỗ (nếu có) để tập trung vào vị trí hiện tại
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }

            // Thêm marker mới tại vị trí gán cứng [cite: 8]
            currentMarker = L.marker(currentLocation).addTo(map)
                .bindPopup('Vị trí của bạn')
                .openPopup();

            // Di chuyển bản đồ đến vị trí
            map.panTo(currentLocation);
        } else {
            // Người dùng từ chối
            // Hiển thị thông báo và không di chuyển bản đồ [cite: 48]
            alert("Không thể lấy vị trí. Vui lòng cấp quyền truy cập vị trí.");
        }
    });

    // --- (Logic Nút "Đặt ngay" (FAB) giữ nguyên) ---
    $('#btnBookNow').on('click', function () {
        $('#loadingModal').modal('show');
        const getUser = $.get('@Url.Action("GetCurrentUserData", "Home")');
        const getSlots = $.get('@Url.Action("GetParkingSlots", "Home")');

        Promise.all([getUser, getSlots]).then(function (results) {
            currentUserData = results[0];
            parkingSlotsData = results[1];

            setTimeout(() => {
                $('#loadingModal').modal('hide');
                let listHtml = '';
                parkingSlotsData.forEach(slot => {
                    listHtml += `
                        <div class="card parking-card"
                             data-id="${slot.Id}"
                             data-lat="${slot.Latitude}"
                             data-lng="${slot.Longitude}">
                            <div class="card-body">
                                <img src="${slot.ImageUrl}" class="img-fluid rounded mb-2" style="width: 100%; height: 100px; object-fit: cover;">
                                <h6 class="card-title">${slot.Name}</h6>
                                <p class="card-text small">${slot.Address}</p>
                                <p class="card-text"><b>Giá: ${slot.Price.toLocaleString('vi-VN')} VNĐ</b></p>
                                <button class="btn btn-sm btn-primary btn-block select-slot-btn"
                                        data-id="${slot.Id}">Chọn bãi này</button>
                            </div>
                        </div>
                    `;
                });
                $('#parkingListCarousel').html(listHtml);
                $('#parkingListCarouselContainer').show();

                // KHÔNG pan đến bãi xe đầu tiên, để bản đồ yên

            }, 2000);
        });
    });

    // --- (Logic Nút "Chọn bãi này" giữ nguyên) ---
    // Cần e.stopPropagation() để không kích hoạt sự kiện click của .parking-card
    $(document).on('click', '.select-slot-btn', function (e) {
        e.stopPropagation(); // QUAN TRỌNG
        const slotId = $(this).data('id');
        selectedSlot = parkingSlotsData.find(s => s.Id == slotId);

        const remainingBalance = currentUserData.Balance - selectedSlot.Price;

        let confirmHtml = `
            <p><strong>Bãi đỗ xe:</strong> ${selectedSlot.Name}</p>
            <p><strong>Địa chỉ:</strong> ${selectedSlot.Address}</p>
            <hr>
            <p><strong>Tài khoản:</strong> ${currentUserData.UserName}</p>
            <p><strong>Số tiền còn lại:</strong>
                ${currentUserData.Balance.toLocaleString('vi-VN')} - ${selectedSlot.Price.toLocaleString('vi-VN')} =
                <b>${remainingBalance.toLocaleString('vi-VN')} VNĐ</b>
            </p>
            <p><strong>Thời gian di chuyển (dự kiến):</strong> 15 phút</p>
        `;
        $('#confirmationBody').html(confirmHtml);
        $('#confirmationModal').modal('show');
    });

    // --- MỚI: Logic Click-để-cuộn-ra-giữa (Thay thế cho logic scroll) ---
    $(document).on('click', '.parking-card', function () {
        const card = $(this);
        const container = $('#parkingListCarousel');

        const lat = card.data('lat');
        const lng = card.data('lng');
        const name = card.find('.card-title').text();

        // 1. Logic cuộn card ra giữa
        const containerWidth = container.width();
        const cardWidth = card.width();
        const cardOffsetLeft = card.position().left; // Vị trí card so với container
        const currentScrollLeft = container.scrollLeft();

        // Tính toán vị trí scroll mới để card nằm giữa
        const targetScrollLeft = currentScrollLeft + cardOffsetLeft - (containerWidth / 2) + (cardWidth / 2);

        // Cuộn mượt
        container.animate({ scrollLeft: targetScrollLeft }, 300);

        // 2. Logic đánh dấu marker trên bản đồ

        // Xóa marker vị trí hiện tại (nếu có)
        if (currentMarker) {
            map.removeLayer(currentMarker);
            currentMarker = null; // Xóa tham chiếu
        }

        // Xóa marker bãi đỗ cũ (nếu có)
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }

        // Cập nhật vị trí đích
        destinationLocation = [lat, lng];

        // Thêm marker bãi đỗ mới và mở popup
        destinationMarker = L.marker(destinationLocation).addTo(map)
            .bindPopup(name)
            .openPopup();

        // 3. Di chuyển bản đồ đến marker mới
        map.panTo(destinationLocation);
    });

    // --- (XÓA BỎ logic sự kiện 'scroll' và hàm handleScrollStop()) ---


    // --- (Các logic còn lại: startTripTimer, btnCancelTrip, btnConfirmBooking, initMap, document.ready... giữ nguyên như cũ) ---

    // Xóa các element trên bản đồ (đường đi, marker đích)
    function clearMapExtras() {
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }
        map.closePopup();
    }

    // Vẽ đường đi
    function drawRoute() {
        clearMapExtras();
        destinationLocation = [selectedSlot.Latitude, selectedSlot.Longitude];

        // Marker đích
        destinationMarker = L.marker(destinationLocation).addTo(map)
            .bindPopup(selectedSlot.Name);

        // Marker vị trí hiện tại (chỉ khi bắt đầu chuyến)
        if (currentMarker) map.removeLayer(currentMarker);
        currentMarker = L.marker(currentLocation).addTo(map)
            .bindPopup('Vị trí của bạn');

        // Đường đi
        const latlngs = [currentLocation, destinationLocation];
        routePolyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);

        map.fitBounds(routePolyline.getBounds());
    }

    // Bắt đầu đếm ngược
    function startTripTimer() {
        let duration = 15;
        $('#tripOverlay').show();
        $('#btnBookNow').hide();
        $('#btnFindLocation').hide(); // Ẩn luôn nút tìm vị trí
        $('#parkingListCarouselContainer').hide();

        tripTimerInterval = setInterval(() => {
            duration--;
            let minutes = Math.floor(duration / 60);
            let seconds = duration % 60;
            $('#tripTimer').text(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);

            if (duration <= 0) {
                clearInterval(tripTimerInterval);
                $('#tripOverlay').hide();
                $('#btnBookNow').show();
                $('#btnFindLocation').show(); // Hiện lại
                clearMapExtras();
                $('#refundModal').modal('show');
            }
        }, 1000);
    }

    // Hủy chuyến
    $('#btnCancelTrip').on('click', function () {
        clearInterval(tripTimerInterval);
        $('#tripOverlay').hide();
        $('#btnBookNow').show();
        $('#btnFindLocation').show(); // Hiện lại
        clearMapExtras();
        $('#refundModal').modal('show');
    });

    // Xác nhận đặt
    $('#btnConfirmBooking').on('click', function () {
        $('#confirmationModal').modal('hide');
        drawRoute();
        startTripTimer();
    });

    // --- Khởi chạy ---
    $(document).ready(function () {
        initMap();

        if ($('#bookingSuccessAlert').length) {
            setTimeout(() => {
                $('#bookingSuccessAlert').alert('close');
            }, 5000);
        }
    });

    </script>
}