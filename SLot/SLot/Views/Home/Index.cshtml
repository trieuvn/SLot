@{
    ViewBag.Title = "Home";
}

@if (TempData["BookingSuccess"] != null)
{
    <div class="alert alert-success alert-dismissible fade show m-3" role="alert" id="bookingSuccessAlert">
        @TempData["BookingSuccess"]
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    </div>
}

<div id="map"></div>

<button class="btn btn-primary fab-button" id="btnBookNow">Đặt ngay</button>

<div id="tripOverlay" class="p-3 bg-white border-top" style="display: none; position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;">
    <p>Thời gian di chuyển còn lại: <strong id="tripTimer">15:00</strong></p>
    <button class="btn btn-danger btn-block" id="btnCancelTrip">Hủy chuyến</button>
</div>

<div id="parkingListCarouselContainer" style="display: none;">
    <div id="parkingListCarousel" class="horizontal-scroll-wrapper">
    </div>
</div>


<div class="modal fade" id="loadingModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Đang tìm bãi đỗ...</p>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận đặt chỗ</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmationBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="btnConfirmBooking">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="refundModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <p>Tài khoản của bạn đã được hoàn lại 50% tiền đặt.</p>
                <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script>
    // Vị trí hiện tại (gán cứng)
    const currentLocation = [@ViewBag.CurrentLocationLat, @ViewBag.CurrentLocationLng];
    // Vị trí bãi đỗ xe được chọn (gán cứng)
    let destinationLocation = [10.7769, 106.7009]; // Gán cứng bãi xe 1

    let map;
    let currentUserData = {};
    let parkingSlotsData = [];
    let selectedSlot = {};
    let tripTimerInterval;
    let routePolyline; // Biến lưu đường đi
    let currentMarker; // Biến lưu marker vị trí hiện tại
    let destinationMarker; // Biến lưu marker vị trí đến
    let debounceTimer; // Biến cho sự kiện scroll (chống giật)

    // Khởi tạo bản đồ
    function initMap() {
        map = L.map('map').setView(currentLocation, 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Marker vị trí hiện tại
        currentMarker = L.marker(currentLocation).addTo(map)
            .bindPopup('Vị trí của bạn')
            .openPopup();
    }

    // Xóa các element trên bản đồ (đường đi, marker đích)
    function clearMapExtras() {
        if (routePolyline) {
            map.removeLayer(routePolyline);
        }
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }
        // Đóng popup nếu có
        map.closePopup();
    }

    // Vẽ đường đi (gán cứng)
    function drawRoute() {
        clearMapExtras(); // Xóa cũ nếu có
        destinationLocation = [selectedSlot.Latitude, selectedSlot.Longitude]; // Cập nhật vị trí đích

        // Tạo marker đích
        destinationMarker = L.marker(destinationLocation).addTo(map)
            .bindPopup(selectedSlot.Name);

        // Tạo đường đi (polyline)
        const latlngs = [currentLocation, destinationLocation];
        routePolyline = L.polyline(latlngs, { color: 'blue' }).addTo(map);

        // Zoom bản đồ để thấy cả 2 điểm
        map.fitBounds(routePolyline.getBounds());
    }

    // Bắt đầu đếm ngược 15 phút (demo là 15 giây)
    function startTripTimer() {
        let duration = 15; // 15 giây cho demo (thay vì 15*60)
        $('#tripOverlay').show();
        $('#btnBookNow').hide(); // Ẩn nút Đặt ngay
        $('#parkingListCarouselContainer').hide(); // Ẩn carousel

        tripTimerInterval = setInterval(() => {
            duration--;
            let minutes = Math.floor(duration / 60);
            let seconds = duration % 60;
            $('#tripTimer').text(`${minutes}:${seconds < 10 ? '0' : ''}${seconds}`);

            if (duration <= 0) {
                // Hết giờ
                clearInterval(tripTimerInterval);
                $('#tripOverlay').hide();
                $('#btnBookNow').show(); // Hiện lại nút
                clearMapExtras();
                $('#refundModal').modal('show');
            }
        }, 1000);
    }

    // Hủy chuyến
    $('#btnCancelTrip').on('click', function () {
        clearInterval(tripTimerInterval);
        $('#tripOverlay').hide();
        $('#btnBookNow').show(); // Hiện lại nút
        clearMapExtras();
        $('#refundModal').modal('show');
    });


    // --- Logic Nút "Đặt ngay" (FAB) ---
    $('#btnBookNow').on('click', function () {
        // 1. Hiển thị loading
        $('#loadingModal').modal('show');

        // 2. Tải dữ liệu (user và bãi xe)
        const getUser = $.get('@Url.Action("GetCurrentUserData", "Home")');
        const getSlots = $.get('@Url.Action("GetParkingSlots", "Home")');

        Promise.all([getUser, getSlots]).then(function (results) {
            currentUserData = results[0];
            parkingSlotsData = results[1];

            // 3. Sau 2 giây, ẩn loading
            setTimeout(() => {
                $('#loadingModal').modal('hide');

                // 4. Render danh sách bãi đỗ vào CAROUSEL
                let listHtml = '';
                parkingSlotsData.forEach(slot => {
                    listHtml += `
                        <div class="card parking-card"
                             data-id="${slot.Id}"
                             data-lat="${slot.Latitude}"
                             data-lng="${slot.Longitude}">
                            <div class="card-body">
                                <img src="${slot.ImageUrl}" class="img-fluid rounded mb-2" style="width: 100%; height: 100px; object-fit: cover;">
                                <h6 class="card-title">${slot.Name}</h6>
                                <p class="card-text small">${slot.Address}</p>
                                <p class="card-text"><b>Giá: ${slot.Price.toLocaleString('vi-VN')} VNĐ</b></p>
                                <button class="btn btn-sm btn-primary btn-block select-slot-btn"
                                        data-id="${slot.Id}">Chọn bãi này</button>
                            </div>
                        </div>
                    `;
                });
                $('#parkingListCarousel').html(listHtml);
                $('#parkingListCarouselContainer').show(); // Hiển thị carousel

                // Pan đến bãi xe đầu tiên
                if(parkingSlotsData.length > 0) {
                    map.panTo([parkingSlotsData[0].Latitude, parkingSlotsData[0].Longitude]);
                    L.popup()
                     .setLatLng([parkingSlotsData[0].Latitude, parkingSlotsData[0].Longitude])
                     .setContent(parkingSlotsData[0].Name)
                     .openOn(map);
                }

            }, 2000); // Đợi 2 giây
        });
    });

    // --- Logic chọn bãi đỗ (TRÊN CARD) ---
    $(document).on('click', '.select-slot-btn', function (e) {
        e.stopPropagation(); // Ngăn sự kiện click của card
        const slotId = $(this).data('id');
        selectedSlot = parkingSlotsData.find(s => s.Id == slotId);

        // Tính toán số tiền
        const remainingBalance = currentUserData.Balance - selectedSlot.Price;

        // 5. Hiển thị popup xác nhận (như cũ)
        let confirmHtml = `
            <p><strong>Bãi đỗ xe:</strong> ${selectedSlot.Name}</p>
            <p><strong>Địa chỉ:</strong> ${selectedSlot.Address}</p>
            <hr>
            <p><strong>Tài khoản:</strong> ${currentUserData.UserName}</p>
            <p><strong>Số tiền còn lại:</strong>
                ${currentUserData.Balance.toLocaleString('vi-VN')} - ${selectedSlot.Price.toLocaleString('vi-VN')} =
                <b>${remainingBalance.toLocaleString('vi-VN')} VNĐ</b>
            </p>
            <p><strong>Thời gian di chuyển (dự kiến):</strong> 15 phút</p>
        `;
        $('#confirmationBody').html(confirmHtml);
        $('#confirmationModal').modal('show');
    });

    // --- Logic xác nhận đặt chỗ ---
    $('#btnConfirmBooking').on('click', function () {
        $('#confirmationModal').modal('hide');

        // 6. Về home, hiển thị đường đi và timer
        drawRoute();
        startTripTimer();
    });

    // --- MỚI: Logic di chuyển bản đồ khi lướt (scroll) carousel  ---
    $('#parkingListCarousel').on('scroll', function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(handleScrollStop, 150); // Chờ 150ms sau khi cuộn dừng
    });

    function handleScrollStop() {
        const container = $('#parkingListCarousel');
        const scrollLeft = container.scrollLeft();
        const cards = container.find('.parking-card');

        let closestCard = null;
        let minDistance = Infinity;

        // Tìm card gần nhất với mép trái (vị trí snap)
        cards.each(function () {
            const card = $(this);
            // .position().left là vị trí tương đối so với container
            const distance = Math.abs(card.position().left);

            if (distance < minDistance) {
                minDistance = distance;
                closestCard = card;
            }
        });

        if (closestCard) {
            const lat = closestCard.data('lat');
            const lng = closestCard.data('lng');
            const name = closestCard.find('.card-title').text();

            // Di chuyển (pan) bản đồ
            map.panTo([lat, lng]);

            // Hiển thị popup tên bãi
            L.popup()
             .setLatLng([lat, lng])
             .setContent(name)
             .openOn(map);
        }
    }


    // --- Khởi chạy ---
    $(document).ready(function () {
        initMap();

        // Tự động ẩn thông báo thành công sau 5s
        if ($('#bookingSuccessAlert').length) {
            setTimeout(() => {
                $('#bookingSuccessAlert').alert('close');
            }, 5000);
        }
    });

    </script>
}